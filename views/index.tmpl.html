{{define "content"}}

    <nav class="navbar navbar-default navbar-static-top navbar-inverse">
        <div class="container">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="/"><span class="glyphicon glyphicon-home"></span> Blaster</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="navbar-right">
                {{if .authorized}}
                    <a href="/auth/logout"><span class="glyphicon glyphicon-user"></span> Logout <i>({{.teamName}})</i></a>
                {{else}}
                    <a href="/auth/initiate"><span class="glyphicon glyphicon-user"></span> Authorize</a>
                {{end}}
                </li>
            </ul>
        </div>
    </nav>

    <div id="container-main" class="container">
        <h1>Blaster</h1>
        <p>Simple tool for sending out announcements.</p>

        <hr/>

        {{if .authorized}}
        <div class="form-group">
            <label>Recipients</label>
            <input id="recipients-field" type="text" class="form-control" placeholder="Type users or user groups" />
        </div>
        
        <div class="form-group">
            <label>Message</label>
            <textarea id="message-field" class="form-control" rows="10" placeholder="Text of your announcement"></textarea>
        </div>

        <button id="submit-button" type="submit" class="btn btn-primary">
            <span class="glyphicon glyphicon-send"></span> Send
        </button>
        {{else}}
        <span class="not-authorized"><b>Not authorized.</b> The form is only available when authorized against Slack API.</span>
        {{end}}

        <div id="progress" class="progress action-progress" style="display: none;">
            <div id="progress-bar" class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
                7/42
            </div>
        </div>

    </div>

    <script>

        var messageState = {
            queue: [],
            count: 0
        };

        $(function() {
            $("#recipients-field")
                .on("tokenfield:createtoken", function(e) {
                    var existingTokens = $(this).tokenfield("getTokens");
                    $.each(existingTokens, function(index, token) {
                        if (token.value === e.attrs.value) {
                            e.preventDefault();
                        }
                    });
                })
                .on("tokenfield:createdtoken", function(e) {
                    if (!e.attrs.type) {
                        $(e.relatedTarget).addClass("invalid");
                    }
                })
                .tokenfield({
                    autocomplete: {
                        source: "/api/suggest",
                        minLength: 3,
                        delay: 500
                    },
                    showAutocompleteOnFocus: true
                });
            
            $("#submit-button").click(function() {
                sendMessage();
            });
        });

        function sendMessage() {
            var users = $("#recipients-field").val().split(", ");
            var message = $("#message-field").val();

            if (users.length == 0 || message.length == 0) return;

            setFormEnabled(false);

            messageState.queue = [];
            messageState.count = users.length;
            for (user of users) {
                messageState.queue.push({user: user, message: message});
            }

            setProgressEnabled(true)
            nextMessage();
        }

        function nextMessage() {
            var remaining = messageState.queue.length;

            setProgressValue(messageState.count - remaining, messageState.count);

            if (remaining == 0) {
                resetForm(true);
                return;
            }

            var message = messageState.queue.pop();

            $.ajax({
                type: "POST",
                url: "/api/send",
                data: JSON.stringify(message),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data) {
                    nextMessage();
                },
                error: function(data) {
                    alert("Error sending message:\n" + JSON.stringify(data, null, 2));
                    resetForm(false);
                }
            });
        }

        function resetForm(success) {
            messageState.queue = [];
            messageState.count = 0;

            if (success) {
                $("#recipients-field").tokenfield('setTokens', []);
                $("#message-field").val("");
            } else {
                setProgressEnabled(false);
            }

            setFormEnabled(true);
        }

        function setFormEnabled(enabled) {
            $("#recipients-field").tokenfield(enabled ? 'enable' : 'disable');
            $("#message-field").prop("disabled", !enabled);
            $("#submit-button").prop("disabled", !enabled);
        }

        function setProgressEnabled(enabled) {
            $("#progress").show();
        }

        function setProgressValue(current, total) {
            var percentage = current / total * 100;
            $("#progress-bar")
                .text(percentage < 100 ? current + "/" + total : "Complete!")
                .css("width", percentage + "%")
                .prop("aria-valuenow", percentage);
        }
    
    </script>

{{end}}
